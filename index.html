<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mes jeux ‚Ä¢ Tableau de bord</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151923; --muted:#aab0c0; --text:#e8ebf2;
      --brand:#7c93ff; --brand-2:#76e0c2; --danger:#ff6b6b; --ok:#3ddc97;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --green-1:#4ade80; --green-2:#22d3ee; --red-1:#ff6b6b; --red-2:#ff3b6b;
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,rgba(124,147,255,.06),transparent 35%),linear-gradient(0deg,rgba(118,224,194,.05),transparent 45%),var(--bg);background-attachment:fixed;color:var(--text)}
    *{box-sizing:border-box} a{color:var(--brand)} button,input,select,textarea{font:inherit;color:inherit}

    .container{max-width:1380px;margin:24px auto;padding:0 16px}
    .layout{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1280px){.layout{grid-template-columns:1fr 420px;align-items:start}}

    .panel{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.01));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}

    .search{display:flex;align-items:center;gap:10px;padding:10px 12px}
    .search input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c0f14;outline:none}

    .filters{display:flex;gap:10px;padding:10px;flex-wrap:wrap}
    .chip{position:relative;padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.22);cursor:pointer;user-select:none;background:#0c0f14;transition:box-shadow .2s,border-color .2s,background .2s}
    .chip:hover{border-color:rgba(255,255,255,.35)}
    .chip:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(124,147,255,.35)}
    .chip[data-active="true"]{background:#0b0e12;border-color:transparent}
    .chip[data-active="true"]::before{content:"";position:absolute;inset:-1px;border-radius:999px;padding:1px;background:linear-gradient(90deg,var(--green-1),var(--green-2));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude}

    .selects{display:flex;gap:10px;padding:10px;flex-wrap:wrap;align-items:center}
    .selects select{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0c0f14;outline:none}

    .switch{position:relative;width:58px;height:30px;display:inline-block}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;border-radius:999px;background:#0b0e12}
    .slider::after{content:"";position:absolute;inset:-1px;border-radius:999px;padding:1px;background:linear-gradient(90deg,var(--green-1),var(--green-2));-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;transition:background .25s ease}
    .slider:before{content:"‚Üì";position:absolute;height:24px;width:24px;left:3px;top:50%;transform:translateY(-50%);display:grid;place-items:center;border-radius:50%;background:#121620;transition:left .22s ease, transform .22s ease}
    .switch input:active + .slider:before{transform:translateY(-50%) scale(.97)}
    .switch input:checked + .slider:before{content:"‚Üë";left:31px}
    .switch input:checked + .slider::after{background:linear-gradient(90deg,var(--red-1),var(--red-2))}
    .hint{color:var(--muted);font-size:.85rem}

    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:640px){.grid{grid-template-columns:1fr 1fr}}
    @media(min-width:1100px){.grid{grid-template-columns:1fr 1fr 1fr}}

    .card{position:relative;overflow:hidden}
    .card .inner{padding:16px}
    .title{font-weight:700;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:.9rem;display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .cover-wrap{width:100%;aspect-ratio:16/6;background:#0b0e12}
    .cover-wrap img{width:100%;height:100%;object-fit:cover;display:block}

    .links{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;position:relative;z-index:5}
    .linkbtn{font-size:.82rem;padding:7px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#0c0f14;text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .linkbtn.vod{border:none;background:linear-gradient(180deg,rgba(124,147,255,.25),rgba(124,147,255,.12));box-shadow:inset 0 0 0 1px rgba(124,147,255,.45)}
    .linkbtn .play{font-size:.85rem}
    .linkbtn.review{border:none;background:linear-gradient(180deg,rgba(61,220,151,.25),rgba(61,220,151,.12));box-shadow:inset 0 0 0 1px rgba(61,220,151,.45)}

    /* Tags 1 ligne + Plus/Moins */
    .badges{position:relative;display:flex;align-items:flex-start;gap:8px;margin-top:10px;--fade-pad:56px}
    .badgesInner{display:flex;flex-wrap:nowrap;overflow:hidden;flex:1 1 auto;min-width:0;max-width:100%}
    .badges[data-expanded="false"] .badgesInner{
      max-width:calc(100% - var(--fade-pad));
      -webkit-mask-image:linear-gradient(to right,#000 0,#000 calc(100% - var(--fade-pad)),transparent 100%);
      mask-image:linear-gradient(to right,#000 0,#000 calc(100% - var(--fade-pad)),transparent 100%);
    }
    .badges[data-expanded="true"] .badgesInner{-webkit-mask-image:none;mask-image:none}
    .moreBtn{flex:0 0 auto;padding:4px 8px;font-size:.72rem;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:#0c0f14;display:none;white-space:nowrap;position:relative;z-index:3;cursor:pointer;user-select:none}

    .badge{display:inline-flex;align-items:center;gap:6px;font-size:.75rem;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:#0c0f14;cursor:pointer}
    .badge.selected{border:1px solid transparent;background:#0b0e12;position:relative}
    .badge.selected::before{
      content:"";position:absolute;inset:-1px;border-radius:999px;padding:1px;background:linear-gradient(90deg,var(--green-1),var(--green-2));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;mask-composite:exclude;
    }

    .progress{height:8px;background:#0b0e12;border-radius:999px;overflow:hidden;margin-top:12px}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand-2));width:0}

    .actions{display:flex;gap:8px;margin-top:14px}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,.15);padding:8px 10px;border-radius:10px;cursor:pointer}
    .ghost:hover{border-color:rgba(255,255,255,.3)}

    .empty{text-align:center;color:var(--muted);padding:40px}

    .fab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:999px;display:grid;place-items:center;background:linear-gradient(180deg,rgba(124,147,255,.25),rgba(124,147,255,.08));border:1px solid rgba(124,147,255,.45);cursor:pointer;box-shadow:var(--shadow);backdrop-filter:blur(6px);z-index:20}
    .fab[hidden]{display:none}
    .fab-secondary{right:86px;bottom:20px;width:56px;height:56px;border-radius:999px;display:grid;place-items:center;background:linear-gradient(180deg,rgba(118,224,194,.25),rgba(118,224,194,.08));border:1px solid rgba(118,224,194,.45)}

    /* ==== Modales scrollables ==== */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:30;padding:12px}
    .modal[open]{display:grid}
    .dialog{
      width:min(840px,94vw);background:var(--panel);border:1px solid rgba(255,255,255,.1);
      border-radius:var(--radius);box-shadow:var(--shadow);max-height:90vh;display:flex;flex-direction:column;
    }
    .dialog .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .dialog .body{padding:16px 18px;display:grid;gap:12px;grid-template-columns:1fr;flex:1 1 auto;overflow:auto}
    @media(min-width:720px){.dialog .body{grid-template-columns:1fr 1fr}}
    .dialog label{font-size:.85rem;color:var(--muted)}
    .dialog input,.dialog select,.dialog textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0c0f14;color:inherit;outline:none;resize:vertical
    }
    .dialog .row-2{grid-column:1 / -1}
    .dialog .foot{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-top:1px solid rgba(255,255,255,.08)}
    .btn{background:linear-gradient(180deg,rgba(118,224,194,.25),rgba(118,224,194,.08));border:1px solid rgba(118,224,194,.45);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .danger{background:linear-gradient(180deg,rgba(255,107,107,.15),rgba(255,107,107,.05));border:1px solid rgba(255,107,107,.5)}

    .twitch{position:sticky;top:16px}
    .twitch .status{display:flex;align-items:center;gap:8px;padding:10px 12px;font-size:.9rem;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:#0c0f14}
    .pill.live{border-color:rgba(61,220,151,.65);color:#b8ffe5}
    .twitchPlayer{aspect-ratio:16/9;width:100%;background:#0b0e12;border-radius:12px;overflow:hidden}
    .twitchChat{height:380px;margin-top:10px;border-radius:12px;overflow:hidden;background:#0b0e12}
    @media(max-width:1279px){.twitchChat{display:none}}

    .twitch-fab{position:fixed;right:16px;bottom:84px;display:none;z-index:19}
    .twitch-fab a{text-decoration:none}
    @media(max-width:1279px){.twitch-fab{display:block}}

    .sr{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap}

    /* ====== √âTOILES (SVG, remplissage pr√©cis) ====== */
    .star-row{display:inline-flex;align-items:center;gap:4px;vertical-align:middle}
    .star-row.sm svg{width:22px;height:22px}     /* cartes */
    .star-row.lg svg{width:30px;height:30px}     /* picker */
    .star-row svg{display:block}
    .star-svg .bg{fill:rgba(255,255,255,.28)}
    .star-svg .fill{fill:var(--brand-2)}
    .star-svg{shape-rendering:geometricPrecision}
    .star-row, .star-row *{pointer-events:none}  /* affichage non interactif */

    .star-input{display:flex;align-items:center;gap:10px}
    .star-input .stars-wrap{position:relative;display:inline-block}
    .star-input .hit{
      position:absolute;inset:0;display:grid;grid-template-columns:repeat(10,1fr);cursor:pointer
    }
    .star-input .hit button{all:unset;cursor:pointer}
    .star-input .hint{color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <div class="container">
    <div class="layout">
      <main>
        <h1 style="margin:0 0 12px 0;">Mes jeux</h1>
        <p style="color:var(--muted); margin:0 0 18px 0;">Rechercher, filtrer, trier. <span class="sr">Texte secondaire.</span></p>

        <div class="panel">
          <div class="search">
            <input id="search" type="search" placeholder="Rechercher un jeu (titre, plateforme, tags, note)" autocomplete="off" />
          </div>
          <div class="filters" id="statusChips"></div>
          <div class="selects">
            <select id="platformSelect"><option value="">Toutes plateformes</option></select>
            <select id="sortSelect">
              <option value="alpha">Tri : Titre</option>
              <option value="updated">Tri : Modifi√©s r√©cemment</option>
              <option value="progress">Tri : Progression</option>
              <option value="rating">Tri : Note</option>
              <option value="status">Tri : Statut</option>
              <option value="duration">Tri : Dur√©e (VOD)</option>
            </select>
            <label class="switch" title="Sens du tri"><input id="sortDir" type="checkbox"><span class="slider"></span></label>
            <button id="clearFilters" class="ghost">R√©initialiser</button>
          </div>
          <div class="hint" style="padding:0 10px 12px 10px">Astuce : clique un tag sur une carte pour filtrer (contour vert = actif).</div>
        </div>

        <div id="grid" class="grid" style="margin-top:16px"></div>
        <div id="empty" class="empty" hidden>Aucun r√©sultat. Modifie les filtres ou la recherche.</div>
      </main>

      <aside>
        <div id="twitchPanel" class="panel twitch" hidden>
          <div class="status">
            <span id="livePill" class="pill">‚óè <span id="liveText">Hors ligne</span></span>
            <span id="twitchTitle" style="margin-left:auto; color:var(--muted)"></span>
          </div>
          <div style="padding:0 10px 10px 10px">
            <div id="twitchEmbed" class="twitchPlayer"></div>
            <div id="twitchChat" class="twitchChat"></div>
            <div style="display:flex; gap:8px; margin-top:10px">
              <a id="twitchLink" class="btn" target="_blank" rel="noopener">Regarder sur Twitch</a>
              <button id="minimizeTwitch" class="ghost">R√©duire</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- FABs (admin only, localhost) -->
  <button id="settingsFab" class="fab fab-secondary" title="Param√®tres (localhost)" hidden>üõ†Ô∏è</button>
  <button id="fab" class="fab" title="Administration (localhost)" hidden>‚öôÔ∏è</button>

  <!-- Mobile Twitch quick link -->
  <div class="twitch-fab"><a id="mobileTwitchBtn" class="btn" target="_blank" rel="noopener">Twitch (live)</a></div>

  <!-- Modal Jeux (ajout/√©dition) -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="dialog">
      <div class="head">
        <strong id="modalTitle">Ajouter un jeu</strong>
        <div>
          <button id="deleteBtn" class="ghost danger" title="Supprimer" hidden>Supprimer</button>
          <button id="closeBtn" class="ghost" title="Fermer">Fermer</button>
        </div>
      </div>
      <div class="body">
        <div><label for="fTitle">Titre</label><input id="fTitle" placeholder="Ex: Batman: Arkham City" /></div>
        <div><label for="fPlatform">Plateforme</label><input id="fPlatform" placeholder="PC, PS5, Xbox‚Ä¶" /></div>
        <div><label for="fStatus">Statut</label><select id="fStatus"></select></div>
        <div><label for="fProgress">Progression (%)</label><input id="fProgress" type="number" min="0" max="100" step="1" placeholder="laisser vide si non pertinent" /></div>
        <div><label for="fTags">Tags</label><input id="fTags" placeholder="action, narratif, GOTY‚Ä¶ (clic sur un tag pour filtrer)" /></div>

        <!-- Note √©toiles -->
        <div class="row-2">
          <label>Note</label>
          <div class="star-input">
            <div class="stars-wrap" id="ratingPickerWrap"></div>
            <span id="ratingHint" class="hint">(aucune)</span>
          </div>
          <input id="fRating" type="hidden" />
        </div>

        <div><label for="fLink">Lien externe</label><input id="fLink" placeholder="https://‚Ä¶ (facultatif)" /></div>
        <div><label for="fLinkLabel">Texte du lien</label><input id="fLinkLabel" placeholder="VOD, Test, Review‚Ä¶ (par d√©faut : VOD)" /></div>
        <div><label for="fCover">Image (URL)</label><input id="fCover" placeholder="https://‚Ä¶ (facultatif) ‚Äî recommand√© : 1200√ó450 px (banni√®re)" /></div>

        <div class="row-2"><label for="fNotes">Notes</label><textarea id="fNotes" rows="4" placeholder="Pens√©es rapides, o√π j'en suis, etc."></textarea></div>
        <div class="row-2"><label for="fReview">Avis (long)</label><textarea id="fReview" rows="6" placeholder="√âcris ton avis complet ici‚Ä¶"></textarea></div>
      </div>
      <div class="foot">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <button id="settingsBtn" class="ghost" title="Param√®tres" style="display:none">‚öô Param√®tres</button>
          <button id="importBtn" class="ghost" title="Importer JSON">Importer JSON</button>
          <button id="exportBtn" class="ghost" title="Exporter JSON">Exporter JSON</button>
          <input id="fileInput" type="file" accept="application/json" hidden />
        </div>
        <div style="display:flex; gap:8px">
          <button id="newBtn" class="ghost">Nouveau</button>
          <button id="saveBtn" class="btn">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Param√®tres (d√©di√©) -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="dialog">
      <div class="head">
        <strong>Param√®tres</strong>
        <div><button id="sCloseBtn" class="ghost" title="Fermer">Fermer</button></div>
      </div>
      <div class="body">
        <div><label for="sTwitch">Cha√Æne Twitch</label><input id="sTwitch" placeholder="ex: ScotchyTAZ" /></div>
        <div><label for="sShowTwitch">Afficher panneau Twitch (desktop)</label>
          <select id="sShowTwitch"><option value="yes">Oui</option><option value="no">Non</option></select>
        </div>
        <div><label for="sIsLive">Indicateur Live (manuel)</label>
          <select id="sIsLive"><option value="auto">Auto (par d√©faut)</option><option value="live">Forcer : En direct</option><option value="offline">Forcer : Hors ligne</option></select>
        </div>
        <div class="row-2">
          <label for="sStatuses">Statuts & ordre (un par ligne, format id=Label)</label>
          <textarea id="sStatuses" rows="5" placeholder="Exemple:
planned=√Ä faire
playing=En cours
replaying=Je refais
unfinished=Pas fini
abandoned=Abandonn√©
finished=Termin√©"></textarea>
        </div>
      </div>
      <div class="foot">
        <div style="display:flex;gap:8px"></div>
        <div style="display:flex; gap:8px"><button id="sSaveBtn" class="btn">Enregistrer</button></div>
      </div>
    </div>
  </div>

  <!-- Modal Avis -->
  <div id="reviewModal" class="modal" aria-hidden="true">
    <div class="dialog">
      <div class="head">
        <strong id="revTitle">Avis</strong>
        <button id="revCloseBtn" class="ghost" title="Fermer">Fermer</button>
      </div>
      <div class="body">
        <div class="row-2" id="revMeta" style="color:var(--muted)"></div>
        <div class="row-2" id="revContent" style="white-space:pre-wrap; line-height:1.6; overflow-wrap:anywhere;"></div>
      </div>
    </div>
  </div>

  <script>
    // ---- Statuts (√©ditables) ----
    let STATUS=[
      {id:'planned',label:'√Ä faire'},
      {id:'playing',label:'En cours'},
      {id:'replaying',label:'Je refais'},
      {id:'unfinished',label:'Pas fini'},
      {id:'abandoned',label:'Abandonn√©'},
      {id:'finished',label:'Termin√©'},
    ];
    let STATUS_WEIGHT={}; function rebuildStatusWeight(){ STATUS_WEIGHT={}; STATUS.forEach((s,i)=>STATUS_WEIGHT[s.id]=i); }
    rebuildStatusWeight();

    const LS_KEY='gamesDataV3', LS_SETTINGS='gamesSettingsV2', LS_PREFS='gamesPrefsV1';
    const ADMIN_ENABLED=(location.hostname==='localhost'||location.hostname==='127.0.0.1');

    let games=[],filtered=[];
    let selectedStatuses=new Set(),selectedPlatform='',selectedTags=new Set(),searchTerm='',sortBy='status',sortDir='asc';
    let editingId=null;
    let settings={twitchChannel:'ScotchyTAZ',showTwitch:true,isLive:'auto', customStatuses:null};

    const $=id=>document.getElementById(id);
    const grid=$('grid'), emptyEl=$('empty'), searchInput=$('search'), chipsWrap=$('statusChips');
    const platformSelect=$('platformSelect'), sortSelect=$('sortSelect'), sortDirInput=$('sortDir'), clearFiltersBtn=$('clearFilters');
    const fab=$('fab'), settingsFab=$('settingsFab'), modal=$('modal'), modalTitle=$('modalTitle'), closeBtn=$('closeBtn'), saveBtn=$('saveBtn'), newBtn=$('newBtn'), deleteBtn=$('deleteBtn');
    const fTitle=$('fTitle'), fPlatform=$('fPlatform'), fStatus=$('fStatus'), fProgress=$('fProgress'), fTags=$('fTags'), fRating=$('fRating'), fNotes=$('fNotes'), fReview=$('fReview'), fLink=$('fLink'), fLinkLabel=$('fLinkLabel'), fCover=$('fCover');
    const exportBtn=$('exportBtn'), importBtn=$('importBtn'), fileInput=$('fileInput');
    const twitchPanel=$('twitchPanel'), twitchEmbed=$('twitchEmbed'), twitchChat=$('twitchChat'), twitchLink=$('twitchLink'), twitchTitle=$('twitchTitle'), livePill=$('livePill'), liveText=$('liveText'), minimizeTwitch=$('minimizeTwitch'), mobileTwitchBtn=$('mobileTwitchBtn');
    const reviewModal=$('reviewModal'), revTitle=$('revTitle'), revContent=$('revContent'), revMeta=$('revMeta'), revCloseBtn=$('revCloseBtn');

    const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
    const nowIso=()=>new Date().toISOString();
    const escapeHtml=s=>String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c]));
    const deburr=s=>String(s).normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').toLowerCase();

    function saveLS(){localStorage.setItem(LS_KEY,JSON.stringify(games));localStorage.setItem(LS_SETTINGS,JSON.stringify({...settings, customStatuses:STATUS}))}
    const loadGames=()=>{try{return JSON.parse(localStorage.getItem(LS_KEY)||'null')}catch{return null}};
    const loadSettings=()=>{try{return JSON.parse(localStorage.getItem(LS_SETTINGS)||'null')}catch{return null}};

    const statusLabel=id=>STATUS.find(s=>s.id===id)?.label||id;
    const uniquePlatforms=()=>[...new Set(games.map(g=>String(g.platform||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    function computePlatformsSelect(){const prev=platformSelect.value; platformSelect.innerHTML='<option value="">Toutes plateformes</option>'+uniquePlatforms().map(p=>`<option value="${p}">${p}</option>`).join(''); if([...platformSelect.options].some(o=>o.value===prev)) platformSelect.value=prev;}

    function toNum(v){return(typeof v==='number'&&!Number.isNaN(v))?v:-1}

    // ----- SVG ETOILES -----
    const SVG_NS="http://www.w3.org/2000/svg";
    const STAR_PATH="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z";

    function createSvgStar(fillRatio){
      const svg=document.createElementNS(SVG_NS,"svg");
      svg.setAttribute("viewBox","0 0 24 24");
      svg.classList.add("star-svg");
      const bg=document.createElementNS(SVG_NS,"path");
      bg.setAttribute("d",STAR_PATH); bg.setAttribute("class","bg");
      svg.appendChild(bg);
      const defs=document.createElementNS(SVG_NS,"defs");
      const clip=document.createElementNS(SVG_NS,"clipPath");
      const clipId="clip-"+Math.random().toString(36).slice(2);
      clip.setAttribute("id",clipId);
      const clipShape=document.createElementNS(SVG_NS,"path");
      clipShape.setAttribute("d",STAR_PATH);
      clip.appendChild(clipShape); defs.appendChild(clip); svg.appendChild(defs);
      const fill=document.createElementNS(SVG_NS,"rect");
      fill.setAttribute("x","0"); fill.setAttribute("y","0"); fill.setAttribute("height","24");
      fill.setAttribute("class","fill"); fill.setAttribute("clip-path",`url(#${clipId})`);
      svg.appendChild(fill);
      fill.setAttribute("width", String(Math.max(0,Math.min(1,fillRatio))*24));
      return { svg, rectFill: fill };
    }
    function buildStarRow(value=0, size='sm'){
      const row=document.createElement('span');
      row.className='star-row '+(size==='lg'?'lg':'sm');
      row._fills=[];
      for(let i=0;i<5;i++){
        const {svg,rectFill}=createSvgStar(0);
        row._fills.push(rectFill);
        row.appendChild(svg);
      }
      setStarRow(row, value);
      return row;
    }
    function setStarRow(row, value){
      const v=Math.max(0,Math.min(5,Number(value)||0));
      for(let i=0;i<5;i++){
        const fill=Math.max(0,Math.min(1,v - i));
        row._fills[i].setAttribute("width", String(fill*24));
      }
      row.title = v ? (v+' / 5') : 'Pas de note';
    }
    function getRatingStars(g){
      if(typeof g.ratingStars==='number') return g.ratingStars;
      if(typeof g.rating==='number') return g.rating/2;
      return null;
    }

    // ----- Dur√©e (depuis linkLabel) -----
    function parseDurationToSeconds(label){
      if(!label) return null;
      const s = String(label).toLowerCase();
      let m = s.match(/(\d+)\s*h\s*(\d{1,2})(?:\s*m(?:in)?)?/);
      if(m){ const h=parseInt(m[1],10), min=parseInt(m[2],10)||0; return h*3600+min*60; }
      m = s.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?/);
      if(m){ const h=parseInt(m[1],10), min=parseInt(m[2],10), sec=parseInt(m[3]||'0',10); return h*3600+min*60+sec; }
      m = s.match(/(\d{1,3})\s*m(?:in)?/);
      if(m){ const min=parseInt(m[1],10); return min*60; }
      return null;
    }

    // ----- Prefs tri -----
    function savePrefs(){ localStorage.setItem(LS_PREFS, JSON.stringify({ sortBy, sortDir })); }
    function loadPrefs(){ try{ return JSON.parse(localStorage.getItem(LS_PREFS)||'null') } catch { return null } }

    // Groupes pour le tri Progression
    function progressGroupRank(g){
      if(g.status==='playing') return 0;
      if(g.status==='finished') return 1;
      return 2;
    }

    // ----- Modale Avis -----
    function openReview(g){
      revTitle.textContent = g.title || 'Avis';
      const metaParts = [];
      if(g.platform) metaParts.push(escapeHtml(g.platform));
      if(g.status) metaParts.push(escapeHtml(statusLabel(g.status)));
      const rs=getRatingStars(g);
      if(typeof rs==='number') metaParts.push(`${rs}‚òÖ/5`);
      if(typeof g.progress==='number') metaParts.push(`${g.progress}%`);
      revMeta.innerHTML = metaParts.join(' ‚Ä¢ ');
      revContent.textContent = g.review || '(Aucun avis pour le moment)';
      reviewModal.setAttribute('open',''); reviewModal.setAttribute('aria-hidden','false');
    }
    function closeReview(){ reviewModal.removeAttribute('open'); reviewModal.setAttribute('aria-hidden','true'); }

    // ----- Filtre + tri -----
    function applyFilters(){
      const sTerm=deburr(searchTerm);
      filtered=games.filter(g=>{
        if(selectedStatuses.size>0 && !selectedStatuses.has(g.status)) return false;
        if(selectedPlatform && g.platform!==selectedPlatform) return false;
        if(selectedTags.size>0){
          const tagsSet=new Set((g.tags||[]).map(t=>String(t).toLowerCase()));
          for(const t of selectedTags){ if(!tagsSet.has(t)) return false; }
        }
        if(sTerm){
          const hay=deburr([g.title,g.platform,(g.tags||[]).join(' '),g.notes,g.review,String(g.rating??''),String(g.ratingStars??'')].join(' '));
          if(!hay.includes(sTerm)) return false;
        }
        return true;
      });

      const dir=(sortDir==='asc')?1:-1;

      switch(sortBy){
        case 'alpha':
          filtered.sort((a,b)=>dir*a.title.localeCompare(b.title)); break;

        case 'updated':
          filtered.sort((a,b)=>dir*(new Date(a.updatedAt)-new Date(b.updatedAt))); break;

        case 'rating': {
          filtered.sort((a,b)=>{
            const ar = (typeof a.ratingStars==='number') ? a.ratingStars : (typeof a.rating==='number' ? a.rating/2 : null);
            const br = (typeof b.ratingStars==='number') ? b.ratingStars : (typeof b.rating==='number' ? b.rating/2 : null);
            const aHas = ar!=null, bHas = br!=null;
            if(aHas!==bHas) return aHas? -1 : 1; // toujours ceux AVEC note en premier
            if(!aHas) return 0;
            return dir*(ar - br);
          });
          break;
        }

        case 'status':
          filtered.sort((a,b)=> dir*((STATUS_WEIGHT[a.status]??99)-(STATUS_WEIGHT[b.status]??99)) || a.title.localeCompare(b.title));
          break;

        case 'duration':
          filtered.sort((a,b)=>{
            const da=parseDurationToSeconds(a.linkLabel||'');
            const db=parseDurationToSeconds(b.linkLabel||'');
            const aMissing=(da==null), bMissing=(db==null);
            if(aMissing && bMissing) return 0;
            if(aMissing) return 1;
            if(bMissing) return -1;
            return dir*(da-db);
          });
          break;

        case 'progress':
          filtered.sort((a,b)=>{
            const ga=progressGroupRank(a), gb=progressGroupRank(b);
            if(ga!==gb) return ga-gb;
            const aHas=typeof a.progress==='number', bHas=typeof b.progress==='number';
            if(aHas!==bHas) return aHas? -1 : 1;   // sans progression en bas du groupe
            if(!aHas && !bHas) return 0;
            return dir*(a.progress - b.progress);   // asc par d√©faut : peu ‚Üí beaucoup
          });
          break;
      }
      render();
    }

    // ----- Tags overflow -----
    function setupBadgesOverflow(container, inner, btn){
      inner.style.flexWrap='nowrap'; inner.style.overflow='hidden'; inner.style.width='auto';
      const need = inner.scrollWidth > inner.clientWidth + 4;
      if (need){
        container.dataset.expanded='false'; btn.style.display='inline-block'; btn.textContent='Plus';
        const pad=(btn.offsetWidth||48)+8; container.style.setProperty('--fade-pad', pad+'px');
      } else { container.dataset.expanded='true'; btn.style.display='none'; container.style.setProperty('--fade-pad','0px'); }
    }
    function toggleBadges(container, inner, btn){
      const isOpen = container.dataset.expanded==='true';
      if (isOpen){
        container.dataset.expanded='false'; inner.style.flexWrap='nowrap'; inner.style.overflow='hidden'; inner.style.width='auto'; btn.textContent='Plus';
      } else {
        container.dataset.expanded='true'; inner.style.flexWrap='wrap'; inner.style.overflow='visible'; inner.style.width='100%'; btn.textContent='Moins';
      }
    }

    // ----- Rendu cartes -----
    function render(){
      grid.innerHTML='';
      if(filtered.length===0){ emptyEl.hidden=false; return }
      emptyEl.hidden=true;
      const frag=document.createDocumentFragment();
      const measureJobs=[];

      for(const g of filtered){
        const card=document.createElement('div'); card.className='card panel';

        if(g.cover){
          const wrap=document.createElement('div'); wrap.className='cover-wrap';
          const img=document.createElement('img'); img.src=g.cover; img.alt=''; img.loading='lazy';
          wrap.appendChild(img); card.appendChild(wrap);
        }

        const inner=document.createElement('div'); inner.className='inner';
        const titleEl=document.createElement('div'); titleEl.className='title'; titleEl.textContent=g.title;
        inner.appendChild(titleEl);

        const subtitle=document.createElement('div'); subtitle.className='subtitle';
        const left=document.createElement('span'); left.textContent=`${g.platform||''} ‚Ä¢ ${statusLabel(g.status)}`;
        subtitle.appendChild(left);

        const rs=getRatingStars(g);
        if(rs!=null){
          const sep=document.createElement('span'); sep.textContent='‚Ä¢';
          sep.style.opacity='.5';
          subtitle.appendChild(sep);
          const stars=buildStarRow(rs,'sm');
          subtitle.appendChild(stars);
        }
        inner.appendChild(subtitle);

        // Tags
        const badgesWrap=document.createElement('div'); badgesWrap.className='badges';
        const innerBadges=document.createElement('div'); innerBadges.className='badgesInner';
        if(g.tags?.length){
          for(const t of g.tags){
            const b=document.createElement('span'); b.className='badge'; b.textContent=t;
            if(selectedTags.has(String(t).toLowerCase())) b.classList.add('selected');
            b.onclick=()=>toggleTagFilter(t);
            innerBadges.appendChild(b);
          }
        }
        const moreBtn=document.createElement('button'); moreBtn.className='moreBtn'; moreBtn.type='button'; moreBtn.textContent='Plus';
        moreBtn.onclick=()=> toggleBadges(badgesWrap, innerBadges, moreBtn);
        badgesWrap.appendChild(innerBadges); badgesWrap.appendChild(moreBtn);
        inner.appendChild(badgesWrap);

        // Progression
        if(typeof g.progress==='number'){
          const wrap=document.createElement('div'); wrap.className='progress';
          const bar=document.createElement('span'); bar.style.width=Math.max(0,Math.min(100,g.progress))+'%';
          wrap.appendChild(bar); inner.appendChild(wrap);
        }

        // Liens (VOD + Voir l'avis)
        const links=document.createElement('div'); links.className='links';
        if(g.link){
          const a=document.createElement('a'); a.className='linkbtn vod'; a.href=g.link; a.target='_blank'; a.rel='noopener';
          a.innerHTML=`<span class="play">‚ñ∂</span><span>${g.linkLabel||'VOD'}</span>`;
          links.appendChild(a);
        }
        if(typeof g.review==='string' && g.review.trim()){
          const r=document.createElement('button'); r.className='linkbtn review'; r.type='button'; r.textContent="Voir l'avis";
          r.onclick=()=>openReview(g);
          links.appendChild(r);
        }
        if(links.children.length>0) inner.appendChild(links);

        // Notes (extrait)
        if(g.notes){
          const p=document.createElement('p'); p.style.marginTop='10px'; p.style.color='var(--muted)'; p.textContent=g.notes;
          inner.appendChild(p);
        }

        // Actions admin
        if(ADMIN_ENABLED){
          const actions=document.createElement('div'); actions.className='actions';
          const editBtn=document.createElement('button'); editBtn.className='ghost'; editBtn.textContent='‚úèÔ∏è Modifier'; editBtn.onclick=()=>openModal(g.id);
          actions.appendChild(editBtn); inner.appendChild(actions);
        }

        card.appendChild(inner); frag.appendChild(card);
        measureJobs.push(()=>setupBadgesOverflow(badgesWrap, innerBadges, moreBtn));
      }
      grid.appendChild(frag);
      requestAnimationFrame(()=>{ measureJobs.forEach(fn=>fn()); });
    }

    // Recompute badges on resize
    window.addEventListener('resize', ()=>{
      document.querySelectorAll('.badges').forEach(bw=>{
        const inner=bw.querySelector('.badgesInner'); const btn=bw.querySelector('.moreBtn');
        if(inner&&btn) setupBadgesOverflow(bw, inner, btn);
      });
    });

    // UI statuts
    function buildStatusUI(){
      chipsWrap.innerHTML='';
      for(const s of STATUS){
        const chip=document.createElement('button');
        chip.className='chip'; chip.type='button'; chip.textContent=s.label; chip.dataset.id=s.id; chip.dataset.active='false';
        chip.onclick=()=>{ if(selectedStatuses.has(s.id))selectedStatuses.delete(s.id); else selectedStatuses.add(s.id); chip.dataset.active=selectedStatuses.has(s.id)?'true':'false'; applyFilters(); };
        chipsWrap.appendChild(chip);
      }
      fStatus.innerHTML=STATUS.map(s=>`<option value="${s.id}">${s.label}</option>`).join('');
    }

    function toggleTagFilter(tag){const key=String(tag).toLowerCase(); if(selectedTags.has(key)) selectedTags.delete(key); else selectedTags.add(key); applyFilters();}

    // ====== STAR PICKER (modale) ======
    let pickerRow=null;
    function buildRatingPicker(initial=0){
      const wrap=$('ratingPickerWrap'); wrap.innerHTML='';
      const row=buildStarRow(initial,'lg'); pickerRow=row;
      const hit=document.createElement('div'); hit.className='hit';
      for(let i=1;i<=10;i++){
        const btn=document.createElement('button');
        btn.addEventListener('mouseenter',()=>{ setStarRow(row, i*0.5); $('ratingHint').textContent=(i*0.5)+' / 5'; });
        btn.addEventListener('click',()=>{ fRating.value=String(i*0.5); setStarRow(row, i*0.5); $('ratingHint').textContent=(i*0.5)+' / 5'; });
        hit.appendChild(btn);
      }
      wrap.appendChild(row); wrap.appendChild(hit);
      // init hint
      const v=Number(fRating.value||initial)||0; setStarRow(row,v); $('ratingHint').textContent=v? (v+' / 5') : '(aucune)';
      // reset preview on mouseleave
      wrap.addEventListener('mouseleave',()=>{ const v=Number(fRating.value||0); setStarRow(row,v); $('ratingHint').textContent=v? (v+' / 5') : '(aucune)'; });
    }

    // ---- Admin: modal jeu
    function openModal(id=null){
      if(!ADMIN_ENABLED) return;
      editingId=id;
      modal.setAttribute('open',''); modal.setAttribute('aria-hidden','false');
      if(id){
        const g=games.find(x=>x.id===id);
        $('modalTitle').textContent='Modifier un jeu'; deleteBtn.hidden=false; fillForm(g);
      } else {
        $('modalTitle').textContent='Ajouter un jeu'; deleteBtn.hidden=true; clearForm();
      }
      // construire/maj le picker
      const initValue = id ? (getRatingStars(games.find(x=>x.id===id))||0) : 0;
      buildRatingPicker(initValue);
    }
    function closeModal(){ modal.removeAttribute('open'); modal.setAttribute('aria-hidden','true'); }

    function clearForm(){
      fTitle.value=''; fPlatform.value=''; fStatus.value=(STATUS[0]?.id||'planned');
      fProgress.value=''; fTags.value=''; fRating.value=''; fNotes.value=''; fReview.value='';
      fLink.value=''; fLinkLabel.value='VOD'; fCover.value='';
    }
    function fillForm(g){
      fTitle.value=g.title; fPlatform.value=g.platform; fStatus.value=g.status;
      fProgress.value=(g.progress??''); fTags.value=(g.tags||[]).join(', ');
      const rs=getRatingStars(g)||''; fRating.value=rs;
      fNotes.value=g.notes||''; fReview.value=g.review||'';
      fLink.value=g.link??''; fLinkLabel.value=g.linkLabel||'VOD'; fCover.value=g.cover??'';
    }
    function readForm(){ 
      const rs = fRating.value===''? null : Number(fRating.value);
      return {
        title:fTitle.value.trim(),
        platform:fPlatform.value.trim(),
        status:fStatus.value,
        progress:fProgress.value===''?null:Math.max(0,Math.min(100,Number(fProgress.value))),
        tags:fTags.value.split(',').map(s=>s.trim()).filter(Boolean),
        ratingStars: rs,
        rating: rs==null? null : rs*2, // compat /10
        notes:fNotes.value.trim(),
        review:fReview.value.trim(),
        link:fLink.value.trim()||null,
        linkLabel:fLinkLabel.value.trim()||'VOD',
        cover:fCover.value.trim()||null
      } 
    }

    function upsertGame(){
      if(!ADMIN_ENABLED) return;
      const data=readForm();
      if(!data.title){alert('Titre obligatoire');return}
      if(!data.platform){alert('Plateforme obligatoire');return}
      if(editingId){
        const idx=games.findIndex(g=>g.id===editingId);
        if(idx>-1){games[idx]={...games[idx],...data,updatedAt:nowIso()}}
      } else {
        games.push({id:uid(),createdAt:nowIso(),updatedAt:nowIso(),progress:null,rating:null,ratingStars:null,notes:'',review:'',cover:null,link:null,linkLabel:'VOD',tags:[],...data});
      }
      saveLS(); computePlatformsSelect(); applyFilters(); setupTwitch(); closeModal();
    }

    function deleteGame(){
      if(!ADMIN_ENABLED) return;
      if(!editingId)return;
      if(!confirm('Supprimer ce jeu ?'))return;
      games=games.filter(g=>g.id!==editingId);
      saveLS(); applyFilters(); closeModal();
    }

    // Import/export
    function exportJSON(){
      const bundle={settings:{...settings,customStatuses:STATUS},games};
      const blob=new Blob([JSON.stringify(bundle,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='games_bundle.json'; a.click(); URL.revokeObjectURL(a.href);
    }
    function importJSON(file){
      if(!ADMIN_ENABLED) return;
      const reader=new FileReader();
      reader.onload=()=>{try{
        const data=JSON.parse(reader.result);
        if(Array.isArray(data)){games=data;}
        else if(data&&Array.isArray(data.games)){
          games=data.games;
          if(data.settings){
            settings={...settings,...data.settings};
            if(Array.isArray(data.settings.customStatuses)){STATUS=data.settings.customStatuses; rebuildStatusWeight();}
          } else if(Array.isArray(data.customStatuses)){STATUS=data.customStatuses; rebuildStatusWeight();}
        } else {throw new Error('JSON invalide')}
        games = games.map(g => ({ ...g, review: (g.review ?? ''), ratingStars: (typeof g.ratingStars==='number'? g.ratingStars : (typeof g.rating==='number'? g.rating/2 : null)) })); // compat
        saveLS(); computePlatformsSelect(); buildStatusUI(); applyFilters(); setupTwitch(); closeModal();
      }catch(e){alert('Import impossible : '+e.message)}};
      reader.readAsText(file);
    }

    // Twitch
    function setupTwitch(){
      const show=!!settings.showTwitch; const channel=(settings.twitchChannel||'').trim(); const parent=encodeURIComponent(location.hostname||'localhost'); const twitchUrl=`https://www.twitch.tv/${channel}`;
      if(!show||!channel){twitchPanel.hidden=true; mobileTwitchBtn.style.display='none'; return;}
      twitchPanel.hidden=false; twitchLink.href=twitchUrl; twitchTitle.textContent=channel?`@${channel}`:''; mobileTwitchBtn.href=twitchUrl;
      const forced=settings.isLive; let live=false; if(forced==='live') live=true; else if(forced==='offline') live=false; else live=false;
      livePill.className='pill'+(live?' live':''); liveText.textContent=live?'En direct':'Hors ligne'; mobileTwitchBtn.textContent=live?'Twitch (LIVE)':'Twitch';
      twitchEmbed.innerHTML=''; const ifr=document.createElement('iframe'); ifr.allow='autoplay; fullscreen; picture-in-picture'; ifr.frameBorder='0'; ifr.width='100%'; ifr.height='100%'; ifr.src=`https://player.twitch.tv/?channel=${encodeURIComponent(channel)}&parent=${parent}&muted=true`; twitchEmbed.appendChild(ifr);
      twitchChat.innerHTML=''; const chat=document.createElement('iframe'); chat.frameBorder='0'; chat.width='100%'; chat.height='100%'; chat.src=`https://www.twitch.tv/embed/${encodeURIComponent(channel)}/chat?parent=${parent}`; twitchChat.appendChild(chat);
    }

    // Param helpers
    function statusesToText(arr) { return arr.map(s => `${s.id}=${s.label}`).join('\n'); }
    function parseStatuses(text) {
      const out = [];
      for (const line of text.split(/\r?\n/)) {
        const m = line.trim(); if (!m) continue;
        const [id, ...labelParts] = m.split('=');
        const idClean=(id||'').trim(); const label=(labelParts.join('=')||'').trim();
        if(!idClean||!label) continue; out.push({id:idClean,label});
      }
      return out.length?out:null;
    }
    function openSettingsModal(){
      if(!ADMIN_ENABLED) return;
      $('sTwitch').value=settings.twitchChannel||''; $('sShowTwitch').value=settings.showTwitch?'yes':'no'; $('sIsLive').value=settings.isLive||'auto'; $('sStatuses').value=statusesToText(STATUS);
      $('settingsModal').setAttribute('open',''); $('settingsModal').setAttribute('aria-hidden','false');
    }
    function closeSettingsModal(){ $('settingsModal').removeAttribute('open'); $('settingsModal').setAttribute('aria-hidden','true'); }
    function saveSettings(){
      if(!ADMIN_ENABLED) return;
      settings.twitchChannel=$('sTwitch').value.trim()||settings.twitchChannel; settings.showTwitch=($('sShowTwitch').value==='yes'); settings.isLive=$('sIsLive').value;
      const parsed=parseStatuses($('sStatuses').value); if(parsed){ STATUS=parsed; rebuildStatusWeight(); }
      saveLS(); buildStatusUI(); applyFilters(); setupTwitch(); closeSettingsModal();
    }

    // Donn√©es d'exemple
    function initSample(){return[
      {id:uid(),title:'Batman: Arkham City',platform:'PC',status:'replaying',progress:35,tags:['action','Batman'],ratingStars:4.5,rating:9,notes:'Reprise en hard mode.',review:'Un classique qui tient encore bien la route.',link:'',linkLabel:'VOD | 1h37',cover:null,createdAt:nowIso(),updatedAt:nowIso()},
      {id:uid(),title:'The Last of Us Part I',platform:'PC',status:'finished',progress:100,tags:['narratif'],ratingStars:5,rating:10,notes:'Coup de c≈ìur.',review:'Histoire et rythme impeccables.',link:'',linkLabel:'VOD | 2h05',cover:null,createdAt:nowIso(),updatedAt:nowIso()},
      {id:uid(),title:'Red Dead Redemption 2',platform:'PC',status:'planned',progress:null,tags:['open-world'],ratingStars:null,rating:null,notes:'Pr√©vu pour stream.',review:'',link:'',linkLabel:'',cover:null,createdAt:nowIso(),updatedAt:nowIso()},
      {id:uid(),title:'Days Gone',platform:'PC',status:'unfinished',progress:52,tags:['zombies'],ratingStars:3,rating:6,notes:'H√©site √† reprendre.',review:'Bons gunfights, r√©p√©titif sur la dur√©e.',link:'',linkLabel:'VOD | 45:12',cover:null,createdAt:nowIso(),updatedAt:nowIso()},
      {id:uid(),title:'Metal Gear Solid',platform:'PS1',status:'playing',progress:18,tags:['infiltration','classique'],ratingStars:null,rating:null,notes:'D√©couverte.',review:'',link:'',linkLabel:'',cover:null,createdAt:nowIso(),updatedAt:nowIso()},
    ]}

    // Bundle JSON
    async function loadBundle() {
      try {
        const res = await fetch('games_bundle.json?ts=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('no json');
        const data = await res.json();
        if (Array.isArray(data)) return { games: data, settings: null };
        if (data && Array.isArray(data.games)) return data;
      } catch (e) {}
      return null;
    }

    // INIT
    async function init(){
      if(ADMIN_ENABLED){fab.hidden=false; settingsFab.hidden=false}

      const bundle = await loadBundle();
      const lsG = loadGames();
      const lsS = loadSettings();

      if (bundle) {
        games = bundle.games;
        if (bundle.settings) {
          settings = { ...settings, ...bundle.settings };
          if (Array.isArray(bundle.settings.customStatuses)) { STATUS = bundle.settings.customStatuses; rebuildStatusWeight(); }
        }
      } else {
        games = (lsG && Array.isArray(lsG)) ? lsG : initSample();
        if (lsS) {
          settings = { ...settings, ...lsS };
          if (Array.isArray(lsS.customStatuses)) { STATUS = lsS.customStatuses; rebuildStatusWeight(); }
        }
      }

      // compat
      games = games.map(g => ({ 
        ...g, 
        review: (g.review ?? ''), 
        ratingStars: (typeof g.ratingStars==='number' ? g.ratingStars : (typeof g.rating==='number' ? g.rating/2 : null))
      }));

      const prefs = loadPrefs();
      if(prefs){ sortBy = prefs.sortBy || sortBy; sortDir = prefs.sortDir || sortDir; }
      sortSelect.value = sortBy;
      sortDirInput.checked = (sortDir==='asc');

      buildStatusUI(); computePlatformsSelect(); applyFilters(); setupTwitch();

      // Events
      searchInput.addEventListener('input',e=>{searchTerm=e.target.value; applyFilters()});
      platformSelect.addEventListener('change',e=>{selectedPlatform=e.target.value; applyFilters()});
      sortSelect.addEventListener('change', e=>{
        sortBy = e.target.value;
        if(sortBy==='alpha' || sortBy==='status' || sortBy==='progress'){ sortDir='asc'; sortDirInput.checked=true; }
        else { sortDir='desc'; sortDirInput.checked=false; }
        applyFilters(); savePrefs();
      });
      sortDirInput.addEventListener('change', e=>{ sortDir = e.target.checked ? 'asc' : 'desc'; applyFilters(); savePrefs(); });

      clearFiltersBtn.onclick=()=>{
        selectedStatuses.clear(); [...chipsWrap.children].forEach(ch=>ch.dataset.active='false');
        selectedPlatform=''; platformSelect.value='';
        sortBy='status'; sortSelect.value='status';
        sortDir='asc'; sortDirInput.checked=true;
        searchTerm=''; searchInput.value='';
        selectedTags.clear();
        applyFilters(); savePrefs();
      };

      // Admin
      fab.onclick=()=>openModal();
      settingsFab.onclick=()=>openSettingsModal();
      closeBtn.onclick=()=>closeModal();
      saveBtn.onclick=()=>upsertGame();
      newBtn.onclick=()=>{editingId=null; clearForm(); modalTitle.textContent='Ajouter un jeu'; deleteBtn.hidden=true; buildRatingPicker(0);};
      deleteBtn.onclick=()=>deleteGame();
      exportBtn.onclick=()=>exportJSON();
      importBtn.onclick=()=>fileInput.click();
      fileInput.onchange=()=>{const f=fileInput.files?.[0]; if(f) importJSON(f)};

      // Param√®tres
      $('sCloseBtn').onclick=()=>closeSettingsModal();
      $('sSaveBtn').onclick=()=>saveSettings();

      // Raccourci admin
      let seq=''; document.addEventListener('keydown',e=>{
        if((e.ctrlKey&&e.altKey&&e.key.toLowerCase()==='a')&&ADMIN_ENABLED){openModal()}
        seq+=e.key.toLowerCase(); if(seq.length>7) seq=seq.slice(-7);
        if(seq.endsWith('scotch')&&ADMIN_ENABLED){openSettingsModal(); seq=''}
      });

      // Twitch minimize
      minimizeTwitch.onclick=()=>{const hidden=twitchEmbed.style.display==='none'; twitchEmbed.style.display=hidden?'block':'none'; minimizeTwitch.textContent=hidden?'R√©duire':'Agrandir'};

      // Modale Avis
      revCloseBtn.onclick = closeReview;
      reviewModal.addEventListener('click', (e)=>{ if(e.target===reviewModal) closeReview(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeReview(); });
    }
    document.addEventListener('DOMContentLoaded',init);
  </script>
</body>
</html>
